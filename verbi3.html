<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allenatore verbi latini - Fixed Edition</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #8e44ad;
            --dark: #2c3e50;
            --success: #27ae60;
            --error: #e74c3c;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: var(--dark); }
        h1 { text-align: center; margin-bottom: 30px; }

        .main-wrapper { 
            display: flex; 
            gap: 20px; 
            width: 100%; 
            max-width: 1800px; 
            margin: 0 auto; 
        }

        .column { flex: 1; display: flex; flex-direction: column; gap: 20px; }

        .container { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            height: 100%;
            position: relative;
        }

        .stats {
            font-size: 0.85em;
            color: #7f8c8d;
            text-align: right;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .setup-box { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid #bbdefb; 
            margin-bottom: 15px; 
        }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .verb-box { 
            background: var(--dark); 
            color: white; 
            padding: 20px; 
            text-align: center; 
            font-size: 2.2em; 
            font-weight: bold; 
            border-radius: 10px 10px 0 0; 
            min-height: 50px;
        }
        .desc-box { 
            background: #f8f9fa; 
            border: 2px dashed #bdc3c7; 
            padding: 20px; 
            border-radius: 10px 10px 0 0; 
            text-align: center; 
            font-size: 1.25em;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .paradigm-box { 
            background: #34495e; 
            color: #bdc3c7; 
            padding: 10px; 
            text-align: center; 
            font-style: italic; 
            font-size: 0.9em; 
            border-radius: 0 0 10px 10px; 
            margin-bottom: 20px; 
        }

        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85em; }
        
        select, button, textarea, input { 
            width: 100%; padding: 12px; border-radius: 6px; 
            border: 1px solid #ccc; font-size: 1em; box-sizing: border-box; 
        }

        button { cursor: pointer; border: none; font-weight: bold; transition: 0.3s; color: white; }
        .btn-gen { background: var(--primary); margin-top: 5px; }
        .btn-check { background: var(--success); margin-top: 15px; font-size: 1.1em; }
        
        textarea { resize: none; margin-top: 15px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #eee; overflow: hidden; }
        .input-ans { margin-top: 10px; font-size: 1.3em; text-align: center; border: 2px solid var(--secondary); outline: none; }

        h2 { margin-top: 0; text-align: center; color: var(--dark); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .dots { text-align: center; color: #bdc3c7; margin-top: 5px; letter-spacing: 5px; }
    </style>
</head>
<body>

<h1>Allenatore verbi latini</h1>

<div class="main-wrapper">
    <div class="column" id="colA">
        <div class="container">
            <h2>1. Analisi grammaticale</h2>
            <div class="stats" id="statsA">Risposte: 0 / 0</div>
            <div class="setup-box">
                <div class="filter-grid">
                    <div><label>Coniugazione:</label>
                        <select id="fConA">
                            <option value="tutte">Tutte</option>
                            <option value="sum">Sum</option>
                            <option value="prima">1Âª</option>
                            <option value="seconda">2Âª</option>
                            <option value="terza">3Âª</option>
                            <option value="mista">3Âª in -io</option>
                            <option value="quarta">4Âª</option>
                            <option value="irregolari">Atematici (eo, fero)</option>
                        </select>
                    </div>
                    <div><label>Diatesi:</label><select id="fDiaA"><option value="entrambe">Entrambe</option><option value="attivo">Attivo</option><option value="passivo">Passivo</option></select></div>
                </div>
                <button class="btn-gen" onclick="nuovaAnalisi()">GENERA</button>
            </div>
            <div class="verb-box" id="dispVerbA">---</div>
            <div class="paradigm-box" id="dispParaA">Paradigma: ---</div>
            <div class="quiz-grid">
                <div><label>Diatesi:</label><select id="rDiaA"><option value="na">N/A</option><option value="attivo">Attivo</option><option value="passivo">Passivo</option></select></div>
                <div><label>Modo:</label><select id="rModA" onchange="checkFieldsA()"><option value="">-- Scegli --</option><option value="indicativo">Indicativo</option><option value="congiuntivo">Congiuntivo</option><option value="imperativo">Imperativo</option><option value="infinito">Infinito</option></select></div>
                <div><label>Tempo:</label><select id="rTemA"><option value="na">N/A</option><option value="presente">Presente</option><option value="imperfetto">Imperfetto</option><option value="futuro">Futuro</option><option value="perfetto">Perfetto</option><option value="piuccheperfetto">Piuccheperfetto</option><option value="futuro anteriore">Futuro Ant.</option></select></div>
                <div><label>Persona:</label><select id="rPerA">
                    <option value="na">N/A</option>
                    <option value="1s">1Âª p. s.</option><option value="2s">2Âª p. s.</option><option value="3s">3Âª p. s.</option>
                    <option value="1p">1Âª p. pl.</option><option value="2p">2Âª p. pl.</option><option value="3p">3Âª p. pl.</option>
                </select></div>
            </div>
            <button class="btn-check" onclick="validaAnalisi()">CONTROLLA</button>
            <div class="dots">...</div>
            <textarea id="esitoA" rows="1" readonly></textarea>
        </div>
    </div>

    <div class="column" id="colP">
        <div class="container">
            <h2>2. Produzione forme verbali</h2>
            <div class="stats" id="statsP">Risposte: 0 / 0</div>
            <div class="setup-box">
                <div class="filter-grid">
                    <div><label>Coniugazione:</label>
                        <select id="fConP">
                            <option value="tutte">Tutte</option>
                            <option value="sum">Sum</option>
                            <option value="prima">1Âª</option>
                            <option value="seconda">2Âª</option>
                            <option value="terza">3Âª</option>
                            <option value="mista">3Âª in -io</option>
                            <option value="quarta">4Âª</option>
                            <option value="irregolari">Atematici (eo, fero)</option>
                        </select>
                    </div>
                    <div><label>Diatesi:</label><select id="fDiaP"><option value="entrambe">Entrambe</option><option value="attivo">Attivo</option><option value="passivo">Passivo</option></select></div>
                </div>
                <button class="btn-gen" style="background: var(--secondary);" onclick="nuovaProduzione()">GENERA</button>
            </div>
            <div class="desc-box" id="descP">...</div>
            <div class="paradigm-box" id="dispParaP">Paradigma: ---</div>
            <label>Scrivi la forma latina corretta (puoi ignorare gli accenti):</label>
            <input type="text" id="inputP" class="input-ans" placeholder="..." autocomplete="off">
            <button class="btn-check" style="background: var(--secondary);" onclick="validaProduzione()">CONTROLLA</button>
            <div class="dots">...</div>
            <textarea id="esitoP" rows="1" readonly></textarea>
        </div>
    </div>
</div>

<script>
const labelsPersona = { "1s": "1Âª p. s.", "2s": "2Âª p. s.", "3s": "3Âª p. s.", "1p": "1Âª p. pl.", "2p": "2Âª p. pl.", "3p": "3Âª p. pl.", "na": "" };
const coniugazioni = {
    sum: [{ pres1: "sum", pres2: "Ä•s", perfetto: "fÅ­Ä«", supino: "fÅ­tÅ«rÅ­m", infinito: "essÄ•", coniugazione: "sum" }],
    prima: [{ pres1: "ÄƒmÅ", pres2: "ÄƒmÄs", perfetto: "ÄƒmÄvÄ«", supino: "ÄƒmÄtÅ­m", infinito: "ÄƒmÄrÄ•", coniugazione: "prima" }],
    seconda: [{ pres1: "mÅnÄ•Å", pres2: "mÅnÄ“s", perfetto: "mÅnÅ­Ä«", supino: "mÅnÄ­tÅ­m", infinito: "mÅnÄ“rÄ•", coniugazione: "seconda" }],
    terza: [{ pres1: "lÄ•gÅ", pres2: "lÄ•gÄ­s", perfetto: "lÄ“gÄ«", supino: "lÄ“ctÅ­m", infinito: "lÄ•gÄ•rÄ•", coniugazione: "terza" }],
    mista: [{ pres1: "cÄƒpÄ­Å", pres2: "cÄƒpÄ­s", perfetto: "cÄ“pÄ«", supino: "cÄƒptÅ­m", infinito: "cÄƒpÄ•rÄ•", coniugazione: "mista" }],
    quarta: [{ pres1: "audÄ­Å", pres2: "audÄ«s", perfetto: "audÄ«vÄ«", supino: "audÄ«tÅ­m", infinito: "audÄ«rÄ•", coniugazione: "quarta" }],
    irregolari: [
        { pres1: "Ä•Å", pres2: "Ä«s", perfetto: "Ä«vÄ«", supino: "Ä­tÅ­m", infinito: "Ä«rÄ•", coniugazione: "atematico" },
        { pres1: "fÄ•rÅ", pres2: "fÄ•rs", perfetto: "tÅ­lÄ«", supino: "lÄtÅ­m", infinito: "fÄ•rrÄ•", coniugazione: "atematico" }
    ]
};

let stats = {
    A: { esatte: 0, totali: 0, indovinati: new Set() },
    P: { esatte: 0, totali: 0, indovinati: new Set() }
};

let sfidaA = null, sfidaP = null;

function rimuoviQuantita(testo) {
    if(!testo) return "";
    return testo.normalize("NFD")
        .replace(/[\u0304\u0306]/g, "")
        .replace(/Ä/g, "a").replace(/Ä“/g, "e").replace(/Ä«/g, "i").replace(/Å/g, "o").replace(/Å«/g, "u")
        .replace(/Äƒ/g, "a").replace(/Ä•/g, "e").replace(/Ä­/g, "i").replace(/Å/g, "o").replace(/Å­/g, "u");
}

function coniuga_sum(modo, tempo, persona) {
    const pIdx = ["1s", "2s", "3s", "1p", "2p", "3p"].indexOf(persona);
    if (modo === "infinito") {
        if (tempo === "presente") return "essÄ•";
        if (tempo === "perfetto") return "fÅ­issÄ•";
        if (tempo === "futuro") return "fÅ­tÅ«rÅ­m essÄ•";
    }
    if (modo === "indicativo") {
        if (tempo === "presente") return ["sum", "Ä•s", "est", "sÅ­mÅ­s", "estÄ­s", "sunt"][pIdx];
        if (tempo === "imperfetto") return ["Ä•rÄƒm", "Ä•rÄs", "Ä•rÄƒt", "Ä•rÄmÅ­s", "Ä•rÄtÄ­s", "Ä•rant"][pIdx];
        if (tempo === "futuro") return ["Ä•rÅ", "Ä•rÄ­s", "Ä•rÄ­t", "Ä•rÄ­mÅ­s", "Ä•rÄ­tÄ­s", "Ä•runt"][pIdx];
        if (tempo === "perfetto") return ["fÅ­Ä«", "fÅ­istÄ«", "fÅ­Ä­t", "fÅ­Ä­mÅ­s", "fÅ­istÄ­s", "fÅ­Ä“runt"][pIdx];
        if (tempo === "piuccheperfetto") return ["fÅ­Ä•rÄƒm", "fÅ­Ä•rÄs", "fÅ­Ä•rÄƒt", "fÅ­Ä•rÄmÅ­s", "fÅ­Ä•rÄtÄ­s", "fÅ­Ä•rant"][pIdx];
        if (tempo === "futuro anteriore") return ["fÅ­Ä•rÅ", "fÅ­Ä•rÄ­s", "fÅ­Ä•rÄ­t", "fÅ­Ä•rÄ­mÅ­s", "fÅ­Ä•rÄ­tÄ­s", "fÅ­Ä•rint"][pIdx];
    }
    if (modo === "congiuntivo") {
        if (tempo === "presente") return ["sÄ­m", "sÄ«s", "sÄ­t", "sÄ«mÅ­s", "sÄ«tÄ­s", "sint"][pIdx];
        if (tempo === "imperfetto") return ["essÄ•m", "essÄ“s", "essÄ•t", "essÄ“mÅ­s", "essÄ“tÄ­s", "essent"][pIdx];
        if (tempo === "perfetto") return ["fÅ­Ä•rÄ­m", "fÅ­Ä•rÄ­s", "fÅ­Ä•rÄ­t", "fÅ­Ä•rÄ­mÅ­s", "fÅ­Ä•rÄ­tÄ­s", "fÅ­Ä•rint"][pIdx];
        if (tempo === "piuccheperfetto") return ["fÅ­issÄ•m", "fÅ­issÄ“s", "fÅ­issÄ•t", "fÅ­issÄ“mÅ­s", "fÅ­issÄ“tÄ­s", "fÅ­issent"][pIdx];
    }
    if (modo === "imperativo") {
        if (tempo === "presente") return (persona === "2s") ? "Ä•s" : "estÄ•";
        if (tempo === "futuro") return ["", "estÅ", "estÅ", "", "estÅtÄ•", "suntÅ"][pIdx];
    }
    return "N/A";
}

function coniuga_terza_io(v, modo, tempo, persona, diatesi) {
    const pIdx = ["1s", "2s", "3s", "1p", "2p", "3p"].indexOf(persona);
    if (modo === "indicativo") {
        if (tempo === "presente") {
            return diatesi === "attivo" 
                ? ["cÄƒpÄ­Å", "cÄƒpÄ­s", "cÄƒpÄ­t", "cÄƒpÄ­mÅ­s", "cÄƒpÄ­tÄ­s", "cÄƒpÄ­unt"][pIdx] 
                : ["cÄƒpÄ­År", "cÄƒpÄ•rÄ­s", "cÄƒpÄ­tÅ­r", "cÄƒpÄ­mÅ­r", "cÄƒpÄ­mÄ­nÄ«", "cÄƒpÄ­untÅ­r"][pIdx];
        }
        if (tempo === "imperfetto") {
            return diatesi === "attivo"
                ? ["cÄƒpÄ­Ä“bÄƒm", "cÄƒpÄ­Ä“bÄs", "cÄƒpÄ­Ä“bÄƒt", "cÄƒpÄ­Ä“bÄmÅ­s", "cÄƒpÄ­Ä“bÄtÄ­s", "cÄƒpÄ­Ä“bant"][pIdx]
                : ["cÄƒpÄ­Ä“bÄƒr", "cÄƒpÄ­Ä“bÄrÄ­s", "cÄƒpÄ­Ä“bÄtÅ­r", "cÄƒpÄ­Ä“bÄmÅ­r", "cÄƒpÄ­Ä“bÄmÄ­nÄ«", "cÄƒpÄ­Ä“bantÅ­r"][pIdx];
        }
        if (tempo === "futuro") {
            return diatesi === "attivo"
                ? ["cÄƒpÄ­Äƒm", "cÄƒpÄ­Ä“s", "cÄƒpÄ­Ä•t", "cÄƒpÄ­Ä“mÅ­s", "cÄƒpÄ­Ä“tÄ­s", "cÄƒpÄ­ent"][pIdx]
                : ["cÄƒpÄ­Äƒr", "cÄƒpÄ­Ä“rÄ­s", "cÄƒpÄ­Ä“tÅ­r", "cÄƒpÄ­Ä“mÅ­r", "cÄƒpÄ­Ä“mÄ­nÄ«", "cÄƒpÄ­entÅ­r"][pIdx];
        }
    }
    if (modo === "congiuntivo" && tempo === "presente") {
        return diatesi === "attivo"
            ? ["cÄƒpÄ­Äƒm", "cÄƒpÄ­Äs", "cÄƒpÄ­Äƒt", "cÄƒpÄ­ÄmÅ­s", "cÄƒpÄ­ÄtÄ­s", "cÄƒpÄ­ant"][pIdx]
            : ["cÄƒpÄ­Äƒr", "cÄƒpÄ­ÄrÄ­s", "cÄƒpÄ­ÄtÅ­r", "cÄƒpÄ­ÄmÅ­r", "cÄƒpÄ­ÄmÄ­nÄ«", "cÄƒpÄ­antÅ­r"][pIdx];
    }
    return coniuga(v, modo, tempo, persona, diatesi);
}

function coniuga_atematici(v, modo, tempo, persona, diatesi) {
    const pIdx = ["1s", "2s", "3s", "1p", "2p", "3p"].indexOf(persona);
    if (v.pres1 === "Ä•Å") {
        if (modo === "indicativo") {
            if (tempo === "presente") return ["Ä•Å", "Ä«s", "Ä­t", "Ä«mÅ­s", "Ä«tÄ­s", "Ä•unt"][pIdx];
            if (tempo === "imperfetto") return ["Ä«bÄƒm", "Ä«bÄs", "Ä«bÄƒt", "Ä«bÄmÅ­s", "Ä«bÄtÄ­s", "Ä«bant"][pIdx];
            if (tempo === "futuro") return ["Ä«bÅ", "Ä«bÄ­s", "Ä«bÄ­t", "Ä«bÄ­mÅ­s", "Ä«bÄ­tÄ­s", "Ä«bunt"][pIdx];
        }
        if (modo === "congiuntivo" && tempo === "presente") return ["Ä•Äƒm", "Ä•Äs", "Ä•Äƒt", "Ä•ÄmÅ­s", "Ä•ÄtÄ­s", "Ä•ant"][pIdx];
        if (modo === "congiuntivo" && tempo === "imperfetto") return ["Ä«rÄ•m", "Ä«rÄ“s", "Ä«rÄ•t", "Ä«rÄ“mÅ­s", "Ä«rÄ“tÄ­s", "Ä«rent"][pIdx];
    }
    if (v.pres1 === "fÄ•rÅ") {
        if (modo === "indicativo" && tempo === "presente") {
            return diatesi === "attivo" 
                ? ["fÄ•rÅ", "fÄ•rs", "fÄ•rt", "fÄ•rÄ­mÅ­s", "fÄ•rtÄ­s", "fÄ•runt"][pIdx]
                : ["fÄ•rÅr", "fÄ•rrÄ­s", "fÄ•rtÅ­r", "fÄ•rÄ­mÅ­r", "fÄ•rÄ­mÄ­nÄ«", "fÄ•runtÅ­r"][pIdx];
        }
        if (modo === "congiuntivo" && tempo === "imperfetto") {
            return diatesi === "attivo"
                ? ["fÄ•rrÄ•m", "fÄ•rrÄ“s", "fÄ•rrÄ•t", "fÄ•rrÄ“mÅ­s", "fÄ•rrÄ“tÄ­s", "fÄ•rrent"][pIdx]
                : ["fÄ•rrÄ•r", "fÄ•rrÄ“rÄ­s", "fÄ•rrÄ“tÅ­r", "fÄ•rrÄ“mÅ­r", "fÄ•rrÄ“mÄ­nÄ«", "fÄ•rrÄ•ntÅ­r"][pIdx];
        }
    }
    return coniuga(v, modo, tempo, persona, diatesi);
}

function coniuga(v, modo, tempo, persona, diatesi) {
    const c = v.coniugazione;
    const pIdx = ["1s", "2s", "3s", "1p", "2p", "3p"].indexOf(persona);
    const rPres = v.infinito.slice(0, -3), rPerf = v.perfetto.slice(0, -1), rSupRoot = v.supino.slice(0, -2);
    
    if (diatesi === "passivo" && ["perfetto", "piuccheperfetto", "futuro anteriore"].includes(tempo)) {
        if (modo === "infinito") return rSupRoot + "Å­m essÄ•";
        const part = rSupRoot + (persona.includes("s") ? "Å­s" : "Ä«");
        const aus = {
            indicativo: { perfetto: ["sum","Ä•s","est","sÅ­mÅ­s","estÄ­s","sunt"], piuccheperfetto: ["Ä•rÄƒm","Ä•rÄs","Ä•rÄƒt","Ä•rÄmÅ­s","Ä•rÄtÄ­s","Ä•rant"], "futuro anteriore": ["Ä•rÅ","Ä•rÄ­s","Ä•rÄ­t","Ä•rÄ­mÅ­s","Ä•rÄ­tÄ­s","Ä•runt"] },
            congiuntivo: { perfetto: ["sÄ­m","sÄ«s","sÄ­t","sÄ«mÅ­s","sÄ«tÄ­s","sint"], piuccheperfetto: ["essÄ•m","essÄ“s","essÄ•t","essÄ“mÅ­s","essÄ“tÄ­s","essent"] }
        };
        return `${part} ${aus[modo][tempo][pIdx]}`;
    }

    if (modo === "infinito") {
        if (tempo === "presente") return diatesi === "attivo" ? v.infinito : (c === "terza" ? rPres + "Ä«" : rPres + {prima:"ÄrÄ«",seconda:"Ä“rÄ«",quarta:"Ä«rÄ«"}[c]);
        if (tempo === "perfetto") return rPerf + "issÄ•";
        if (tempo === "futuro") return diatesi === "attivo" ? rSupRoot + "Å«rÅ­m essÄ•" : v.supino + " Ä«rÄ«";
    }

    if (modo === "imperativo") {
        if (tempo === "presente") return rPres + (persona === "2s" ? {prima:"Ä",seconda:"Ä“",terza:"Ä•",quarta:"Ä«"}[c] : {prima:"ÄtÄ•",seconda:"Ä“tÄ•",terza:"Ä­tÄ•",quarta:"Ä«tÄ•"}[c]);
        if (tempo === "futuro") {
            const suf = {prima:"ÄtÅ", seconda:"Ä“tÅ", terza:"Ä­tÅ", quarta:"Ä«tÅ"}[c];
            if (persona === "2s" || persona === "3s") return rPres + suf;
            if (persona === "2p") return rPres + suf + "tÄ•";
            if (persona === "3p") return rPres + (c === "prima" ? "antÅ" : (c === "quarta" ? "Ä­untÅ" : "untÅ"));
        }
    }

    if (diatesi === "attivo") {
        if (tempo === "perfetto") return rPerf + ["Ä«", "istÄ«", "Ä­t", "Ä­mÅ­s", "istÄ­s", "Ä“runt"][pIdx];
        if (tempo === "piuccheperfetto") {
            if (modo === "indicativo") return rPerf + ["Ä•rÄƒm", "Ä•rÄs", "Ä•rÄƒt", "Ä•rÄmÅ­s", "Ä•rÄtÄ­s", "Ä•rant"][pIdx];
            if (modo === "congiuntivo") return rPerf + ["issÄ•m", "issÄ“s", "issÄ•t", "issÄ“mÅ­s", "issÄ“tÄ­s", "issent"][pIdx];
        }
        if (tempo === "futuro anteriore") return rPerf + ["Ä•rÅ", "Ä•rÄ­s", "Ä•rÄ­t", "Ä•rÄ­mÅ­s", "Ä•rÄ­tÄ­s", "Ä•rint"][pIdx];
    }

    const des = {
        indicativo: {
            presente: { attivo: { prima: ["Å","Äs","Äƒt","ÄmÅ­s","ÄtÄ­s","ant"], seconda: ["Ä•Å","Ä“s","Ä•t","Ä“mÅ­s","Ä“tÄ­s","ent"], terza: ["Å","Ä­s","Ä­t","Ä­mÅ­s","Ä­tÄ­s","unt"], quarta: ["Ä­Å","Ä«s","Ä­t","Ä«mÅ­s","Ä«tÄ­s","Ä­unt"] }, passivo: { prima: ["År","ÄrÄ­s","ÄtÅ­r","ÄmÅ­r","ÄmÄ­nÄ«","antÅ­r"], seconda: ["Ä•År","Ä“rÄ­s","Ä“tÅ­r","Ä“mÅ­r","Ä“mÄ­nÄ«","entÅ­r"], terza: ["År","Ä•rÄ­s","Ä­tÅ­r","Ä­mÅ­r","Ä­mÄ­nÄ«","untÅ­r"], quarta: ["Ä­År","Ä«rÄ­s","Ä«tÅ­r","Ä«mÅ­r","Ä«mÄ­nÄ«","Ä­untÅ­r"] } },
            imperfetto: { attivo: { prima: ["ÄbÄƒm","ÄbÄs","ÄbÄƒt","ÄbÄmÅ­s","ÄbÄtÄ­s","Äbant"], seconda: ["Ä“bÄƒm","Ä“bÄs","Ä“bÄƒt","Ä“bÄmÅ­s","Ä“bÄtÄ­s","Ä“bant"], terza: ["Ä“bÄƒm","Ä“bÄs","Ä“bÄƒt","Ä“bÄmÅ­s","Ä“bÄtÄ­s","Ä“bant"], quarta: ["Ä­Ä“bÄƒm","Ä­Ä“bÄs","Ä­Ä“bÄƒt","Ä­Ä“bÄmÅ­s","Ä­Ä“bÄtÄ­s","Ä­Ä“bant"] }, passivo: { prima: ["ÄbÄƒr","ÄbÄrÄ­s","ÄbÄtÅ­r","ÄbÄmÅ­r","ÄbÄmÄ­nÄ«","ÄbantÅ­r"], seconda: ["Ä“bÄƒr","Ä“bÄrÄ­s","Ä“bÄtÅ­r","Ä“bÄmÅ­r","Ä“bÄmÄ­nÄ«","Ä“bantÅ­r"], terza: ["Ä“bÄƒr","Ä“bÄrÄ­s","Ä“bÄtÅ­r","Ä“bÄmÅ­r","Ä“bÄmÄ­nÄ«","Ä“bantÅ­r"], quarta: ["Ä­Ä“bÄƒr","Ä­Ä“bÄrÄ­s","Ä­Ä“bÄtÅ­r","Ä­Ä“bÄmÅ­r","Ä­Ä“bÄmÄ­nÄ«","Ä­Ä“bantÅ­r"] } },
            futuro: { attivo: { prima: ["ÄbÅ","ÄbÄ­s","ÄbÄ­t","ÄbÄ­mÅ­s","ÄbÄ­tÄ­s","Äbunt"], seconda: ["Ä“bÅ","Ä“bÄ­s","Ä“bÄ­t","Ä“bÄ­mÅ­s","Ä“bÄ­tÄ­s","Ä“bunt"], terza: ["Äƒm","Ä“s","Ä•t","Ä“mÅ­s","Ä“tÄ­s","ent"], quarta: ["Ä­Äƒm","Ä­Ä“s","Ä­Ä•t","Ä­Ä“mÅ­s","Ä­Ä“tÄ­s","Ä­ent"] }, passivo: { prima: ["ÄbÅr","ÄbÄ•rÄ­s","ÄbÄ­tÅ­r","ÄbÄ­mÅ­r","ÄbÄ­mÄ­nÄ«","ÄbuntÅ­r"], seconda: ["Ä“bÅr","Ä“bÄ•rÄ­s","Ä“bÄ­tÅ­r","Ä“bÄ­mÅ­r","Ä“bÄ­mÄ­nÄ«","Ä“buntÅ­r"], terza: ["Äƒr","Ä“rÄ­s","Ä“tÅ­r","Ä“mÅ­r","Ä“mÄ­nÄ«","entÅ­r"], quarta: ["Ä­Äƒr","Ä­Ä“rÄ­s","Ä­Ä“tÅ­r","Ä­Ä“mÅ­r","Ä­Ä“mÄ­nÄ«","Ä­entÅ­r"] } }
        }
    };

    if (modo === "congiuntivo") {
        if (tempo === "presente") return rPres + {attivo:{prima:["Ä•m","Ä“s","Ä•t","Ä“mÅ­s","Ä“tÄ­s","ent"],seconda:["Ä•Äƒm","Ä•Äs","Ä•Äƒt","Ä•ÄmÅ­s","Ä•ÄtÄ­s","Ä•ant"],terza:["Äƒm","Äs","Äƒt","ÄmÅ­s","ÄtÄ­s","ant"],quarta:["Ä­Äƒm","Ä­Äs","Ä­Äƒt","Ä­ÄmÅ­s","Ä­ÄtÄ­s","Ä­ant"]},passivo:{prima:["Ä•r","Ä“rÄ­s","Ä“tÅ­r","Ä“mÅ­r","Ä“mÄ­nÄ«","entÅ­r"],seconda:["Ä•Äƒr","Ä•ÄrÄ­s","Ä•ÄtÅ­r","Ä•ÄmÅ­r","Ä•ÄmÄ­nÄ«","Ä•antÅ­r"],terza:["Äƒr","ÄrÄ­s","ÄtÅ­r","ÄmÅ­r","amini","antÅ­r"],quarta:["Ä­Äƒr","Ä­ÄrÄ­s","Ä­ÄtÅ­r","Ä­ÄmÅ­r","Ä­ÄmÄ­nÄ«","Ä­antÅ­r"]}}[diatesi][c][pIdx];
        if (tempo === "imperfetto") return v.infinito + (diatesi === "attivo" ? ["m","s","t","mÅ­s","tÄ­s","nt"] : ["r","rÄ­s","tÅ­r","mÅ­r","mÄ­nÄ«","ntÅ­r"])[pIdx];
        if (tempo === "perfetto") return rPerf + ["Ä•rÄ­m", "Ä•rÄ­s", "Ä•rÄ­t", "Ä•rÄ­mÅ­s", "Ä•rÄ­tÄ­s", "Ä•rint"][pIdx];
    }
    try { 
        let res = des[modo][tempo][diatesi][c][pIdx];
        // Se la desinenza inizia con la vocale tematica giÃ  presente in rPres, evita duplicazioni
        return rPres + res;
    } catch(e) { return "N/A"; }
}

function generaDati(fConId, fDiaId, idStats) {
    const fCon = document.getElementById(fConId).value;
    const fDia = document.getElementById(fDiaId).value;
    let pool = (fCon === "tutte") ? Object.values(coniugazioni).flat() : coniugazioni[fCon];
    const v = pool[Math.floor(Math.random()*pool.length)];
    let m = ["indicativo", "congiuntivo", "infinito", "imperativo"][Math.floor(Math.random()*4)];
    let d = (v.coniugazione === "sum") ? "attivo" : ((fDia === "entrambe") ? (Math.random() > 0.5 ? "attivo" : "passivo") : fDia);
    let t = ["presente", "imperfetto", "futuro", "perfetto", "piuccheperfetto", "futuro anteriore"][Math.floor(Math.random()*6)];
    let p = ["1s", "2s", "3s", "1p", "2p", "3p"][Math.floor(Math.random()*6)];

    if (m === "infinito") { p = "na"; t = ["presente", "perfetto", "futuro"][Math.floor(Math.random()*3)]; }
    else if (m === "imperativo") { t = Math.random() > 0.5 ? "presente" : "futuro"; d = "attivo"; p = (t === "futuro") ? ["2s","3s","2p","3p"][Math.floor(Math.random()*4)] : (Math.random() > 0.5 ? "2s" : "2p"); }
    else if (m === "congiuntivo" && (t === "futuro" || t === "futuro anteriore")) t = "presente";

    let parola = "N/A";
    if (v.coniugazione === "sum") parola = coniuga_sum(m, t, p);
    else if (v.coniugazione === "mista") parola = coniuga_terza_io(v, m, t, p, d);
    else if (v.coniugazione === "atematico") parola = coniuga_atematici(v, m, t, p, d);
    else parola = coniuga(v, m, t, p, d);

    const idForma = `${v.pres1}_${m}_${t}_${p}_${d}`;
    if (parola === "N/A" || parola === undefined || parola.includes("undefined") || stats[idStats].indovinati.has(idForma)) {
        if (stats[idStats].indovinati.size > 500) stats[idStats].indovinati.clear(); 
        return generaDati(fConId, fDiaId, idStats);
    }
    
    return { parola, v, m, t, p, d, idForma };
}

function updateStatsUI(id) {
    document.getElementById(`stats${id}`).innerText = `Risposte: ${stats[id].esatte} / ${stats[id].totali}`;
}

function nuovaAnalisi() {
    sfidaA = generaDati("fConA", "fDiaA", 'A');
    document.getElementById("dispVerbA").innerText = sfidaA.parola;
    document.getElementById("dispParaA").innerText = `Paradigma: ${sfidaA.v.pres1}, ${sfidaA.v.pres2}, ${sfidaA.v.perfetto}, ${sfidaA.v.supino}, ${sfidaA.v.infinito}`;
    document.getElementById("esitoA").value = "";
}

function validaAnalisi() {
    if(!sfidaA || document.getElementById("esitoA").value !== "") return;
    const m = document.getElementById("rModA").value, t = document.getElementById("rTemA").value, d = document.getElementById("rDiaA").value, p = document.getElementById("rPerA").value;
    const corretto = (m === sfidaA.m) && (p === sfidaA.p) && (t === sfidaA.t) && (d === sfidaA.d);
    
    stats.A.totali++;
    if(corretto) {
        stats.A.esatte++;
        stats.A.indovinati.add(sfidaA.idForma);
    }
    updateStatsUI('A');

    const e = document.getElementById("esitoA");
    const m_cap = sfidaA.m.charAt(0).toUpperCase() + sfidaA.m.slice(1);
    const pers = labelsPersona[sfidaA.p] ? " " + labelsPersona[sfidaA.p] : "";
    e.value = corretto ? "CORRETTO! âœ¨" : `ERRATO! Era: ${m_cap} ${sfidaA.t} ${sfidaA.d}${pers}`;
    e.style.color = corretto ? "var(--success)" : "var(--error)";
}

function nuovaProduzione() {
    sfidaP = generaDati("fConP", "fDiaP", 'P');
    let inf = sfidaP.v.infinito.charAt(0).toUpperCase() + sfidaP.v.infinito.slice(1);
    let modo_t = sfidaP.m.charAt(0).toUpperCase() + sfidaP.m.slice(1);
    let d_t = sfidaP.d !== 'na' ? " " + sfidaP.d : "";
    let p_t = labelsPersona[sfidaP.p] ? " " + labelsPersona[sfidaP.p] : "";
    document.getElementById("descP").innerHTML = `${inf} : ${modo_t} ${sfidaP.t}${d_t}${p_t}`;
    document.getElementById("dispParaP").innerText = `Paradigma: ${sfidaP.v.pres1}, ${sfidaP.v.pres2}, ${sfidaP.v.perfetto}, ${sfidaP.v.supino}, ${sfidaP.v.infinito}`;
    document.getElementById("inputP").value = "";
    document.getElementById("esitoP").value = "";
    document.getElementById("inputP").focus();
}

function validaProduzione() {
    if(!sfidaP || document.getElementById("esitoP").value !== "") return;
    const risp = rimuoviQuantita(document.getElementById("inputP").value.trim().toLowerCase());
    const soluzione = rimuoviQuantita(sfidaP.parola.toLowerCase());
    const e = document.getElementById("esitoP");
    
    const corretto = (risp === soluzione);
    
    stats.P.totali++;
    if(corretto) {
        stats.P.esatte++;
        stats.P.indovinati.add(sfidaP.idForma);
    }
    updateStatsUI('P');

    e.value = corretto ? "ESATTO! ðŸ†" : `SBAGLIATO! Era: ${sfidaP.parola}`;
    e.style.color = corretto ? "var(--success)" : "var(--error)";
}

function checkFieldsA() {
    const m = document.getElementById("rModA").value;
    document.getElementById("rPerA").disabled = (m === "infinito");
    document.getElementById("rDiaA").disabled = (m === "imperativo");
}

document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const esitoA = document.getElementById("esitoA").value;
        const esitoP = document.getElementById("esitoP").value;
        if (document.activeElement.id === 'inputP') {
            if (esitoP !== "") nuovaProduzione(); else validaProduzione();
        } else if (document.getElementById('colA').contains(document.activeElement) || document.activeElement.tagName === 'SELECT') {
             if (esitoA !== "") nuovaAnalisi(); else validaAnalisi();
        }
    }
});

window.onload = () => { nuovaAnalisi(); nuovaProduzione(); };
</script>
</body>
</html>